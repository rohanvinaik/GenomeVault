from fastapi.testclient import TestClient

from genomevault.api.app import app


def test_vectors_encode_requires_api_key(monkeypatch):
    # Enable auth by setting a key
    monkeypatch.setenv("GV_API_KEYS", "devkey")
    client = TestClient(app)
    # Without key -> 401
    r = client.post(
        "/vectors/encode",
        json={
            "data": {"x": [0.1, 0.2]},
            "dimension": "10000",
            "compression_tier": "mini",
        },
    )
    assert r.status_code in (401, 403)
    # With key -> 200 or 400 depending on engine availability; but not 401
    r = client.post(
        "/vectors/encode",
        headers={"X-API-Key": "devkey"},
        json={
            "data": {"x": [0.1, 0.2]},
            "dimension": "10000",
            "compression_tier": "mini",
        },
    )
    assert r.status_code != 401





